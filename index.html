<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>ğŸŒ€ Chaos Clean RPG</title>

  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700;800&family=Fraunces:wght@600;700;900&display=swap" rel="stylesheet">

  <style>
    :root {
      --daily: #60A5FA;
      --kitchen: #FCD34D;
      --bathrooms: #67E8F9;
      --master: #EC4899;
      --kids: #F9A8D4;
      --living: #60A5FA;
      --laundry: #A78BFA;
      --entry: #34D399;
      --outside: #FB923C;

      --bg: #0F172A;
      --surface: #1E293B;
      --soft: rgba(255,255,255,0.06);
      --border: rgba(255,255,255,0.12);
      --text: #F1F5F9;
      --text-dim: #94A3B8;

      --success: #10B981;
      --danger: #EF4444;
      --warn: #F59E0B;
    }

    * { margin:0; padding:0; box-sizing:border-box; }

    body {
      font-family: 'DM Sans', sans-serif;
      background: linear-gradient(135deg, #0F172A 0%, #111827 60%, #0B1226 100%);
      color: var(--text);
      min-height: 100vh;
      padding: 18px;
      padding-bottom: 110px;
    }

    .container { max-width: 1400px; margin: 0 auto; }

    header { margin-bottom: 14px; }

    h1 {
      font-family: 'Fraunces', serif;
      font-size: 2.6rem;
      font-weight: 900;
      background: linear-gradient(135deg, #60A5FA 0%, #A78BFA 50%, #EC4899 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 6px;
      line-height: 1.05;
    }

    .tagline {
      color: var(--text-dim);
      margin-bottom: 10px;
      font-size: 1rem;
    }

    .navRow {
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom: 8px;
    }
    .navLink {
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 10px 12px;
      border-radius: 14px;
      background: var(--soft);
      border: 1px solid var(--border);
      color: var(--text);
      text-decoration:none;
      font-weight: 900;
    }
    .navLink.active { outline: 2px solid rgba(96,165,250,0.45); }

    .panel {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 14px;
      margin-bottom: 14px;
    }

    .topbar {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      flex-wrap:wrap;
    }

    .pillrow { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

    .pill {
      background: var(--soft);
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 7px 12px;
      font-weight: 900;
      letter-spacing: 0.02em;
    }
    .pill span { color: #FCD34D; }

    .btnrow { display:flex; gap:10px; flex-wrap:wrap; }

    .btn {
      padding: 11px 14px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.16);
      color: white;
      font-weight: 900;
      cursor: pointer;
      user-select:none;
    }
    .btn:hover { background: rgba(255,255,255,0.20); }
    .btn:active { background: rgba(255,255,255,0.26); }
    .btn.danger { background: var(--danger); border-color: rgba(255,255,255,0.10); }
    .btn.primary { background: var(--daily); color: var(--bg); border-color: rgba(0,0,0,0.12); }
    .btn.ghost { background: transparent; border: 1px solid rgba(255,255,255,0.18); }

    .hint {
      margin-top: 10px;
      color: var(--text-dim);
      line-height: 1.35;
    }

    .toggles {
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }

    .toggleBtn {
      flex:1;
      min-width: 140px;
      padding: 12px;
      border-radius: 14px;
      border: 2px solid transparent;
      background: var(--soft);
      color: var(--text);
      font-weight: 900;
      cursor:pointer;
    }
    .toggleBtn.active { background: var(--daily); color: var(--bg); }

    .taskGrid {
      display:grid;
      gap: 16px;
    }

    .taskCard {
      background: var(--surface);
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.10);
      padding: 14px;
      border-top: 4px solid var(--daily);
    }

    .taskCard.kitchen { border-top-color: var(--kitchen); }
    .taskCard.bathrooms { border-top-color: var(--bathrooms); }
    .taskCard.master { border-top-color: var(--master); }
    .taskCard.kids { border-top-color: var(--kids); }
    .taskCard.living { border-top-color: var(--living); }
    .taskCard.laundry { border-top-color: var(--laundry); }
    .taskCard.entry { border-top-color: var(--entry); }
    .taskCard.outside { border-top-color: var(--outside); }

    .taskHeader {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      margin-bottom: 10px;
    }

    .titleWrap { display:flex; align-items:center; gap: 10px; }
    .icon { font-size: 1.6rem; }
    .taskHeader h3 { font-size: 1.2rem; }
    .badge {
      padding: 6px 12px;
      border-radius: 999px;
      background: var(--daily);
      color: var(--bg);
      font-weight: 900;
      font-size: 0.78rem;
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }

    .taskList { display:flex; flex-direction:column; gap: 10px; }

    .taskItem {
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 10px;
      border-radius: 12px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.06);
      cursor:pointer;
      user-select:none;
    }
    .taskItem:hover { background: rgba(255,255,255,0.075); }
    .taskItem:active { background: rgba(255,255,255,0.11); }

    .checkbox {
      width: 24px;
      height: 24px;
      border-radius: 7px;
      border: 2px solid var(--text-dim);
      display:flex;
      align-items:center;
      justify-content:center;
      flex-shrink:0;
    }

    .taskItem.completed .checkbox { background: var(--success); border-color: var(--success); }
    .taskItem.completed .checkbox::after { content: "âœ“"; font-weight: 900; color: white; }
    .taskItem.completed .taskText { text-decoration: line-through; opacity: 0.65; }

    .taskText { flex:1; font-size: 0.95rem; }

    .progressSection {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid rgba(255,255,255,0.10);
    }
    .progressLabel {
      display:flex;
      justify-content:space-between;
      color: var(--text-dim);
      font-size: 0.88rem;
      margin-bottom: 8px;
    }
    .progressBar {
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.12);
      overflow:hidden;
    }
    .progressFill {
      height: 100%;
      width: 0%;
      background: var(--success);
      border-radius: 999px;
      transition: width 0.25s ease;
    }

    /* Laundry timer box */
    .timerBox {
      background: rgba(167,139,250,0.24);
      border: 1px solid rgba(255,255,255,0.14);
      border-radius: 16px;
      padding: 14px;
      margin-bottom: 14px;
    }
    .timerDisplay {
      font-size: 2.6rem;
      font-weight: 900;
      text-align:center;
      margin: 10px 0 12px 0;
    }
    .timerRow {
      display:flex;
      gap:10px;
      justify-content:center;
      flex-wrap:wrap;
    }
    .timerInput {
      width: 160px;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.16);
      color: white;
      font-weight: 900;
      outline:none;
    }

    /* Sparkles */
    .spark {
      position: fixed;
      font-size: 18px;
      pointer-events:none;
      z-index: 99999;
      animation: sparkPop .9s ease-out forwards;
    }
    @keyframes sparkPop {
      0% { transform: translate(-50%, 0) scale(0.6); opacity:0; }
      20% { opacity:1; }
      100% { transform: translate(-50%, -120px) scale(1.3); opacity:0; }
    }

    /* Modals */
    .overlay {
      display:none;
      position:fixed;
      inset:0;
      background: rgba(0,0,0,0.60);
      z-index: 9999;
      padding: 18px;
    }
    .modal {
      max-width: 820px;
      margin: 60px auto;
      background: var(--surface);
      border: 1px solid rgba(255,255,255,0.14);
      border-radius: 18px;
      padding: 14px;
    }
    .modalHead {
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 10px;
      margin-bottom: 8px;
    }
    .modalHead h2 {
      font-family:'Fraunces',serif;
      font-size: 1.6rem;
    }
    .modalHint { color: var(--text-dim); line-height: 1.35; margin-bottom: 12px; }
    .modalList { display:grid; gap: 10px; }
    .small { color: var(--text-dim); font-size: 0.92rem; line-height: 1.35; margin-top: 10px; }

    .lootCard {
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 14px;
      padding: 10px;
    }

    /* Chaos plan rows */
    .planStep {
      display:flex;
      gap:10px;
      align-items:flex-start;
      padding: 10px;
      border-radius: 14px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.08);
    }
    .planNum {
      min-width: 28px;
      text-align:center;
      font-weight: 900;
      color: #FCD34D;
    }
    .planTitle { font-weight: 900; }
    .planSub { color: var(--text-dim); font-size: 0.9rem; margin-top: 2px; }

    @media (max-width: 780px) {
      h1 { font-size: 2.2rem; }
      .toggleBtn { min-width: 120px; }
      .timerInput { width: 100%; }
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <h1>ğŸŒ€ Chaos Clean RPG</h1>
      <div class="tagline">Calendar-based cleaning + loot drops. Weâ€™re gaming adulthood.</div>
      <div class="navRow">
        <a class="navLink active" href="index.html">ğŸ§¼ Cleaning</a>
        <a class="navLink" href="meal.html">ğŸ½ï¸ Meal Planning</a>
      </div>
    </header>

    <!-- HUD -->
    <div class="panel">
      <div class="topbar">
        <div class="pillrow">
          <div class="pill">ğŸ“… <span id="todayLabel">â€”</span></div>
          <div class="pill">ğŸ‘¦ Week: <span id="custodyLabel">â€”</span></div>
          <div class="pill">ğŸª™ Coins: <span id="coinCount">0</span></div>
          <div class="pill">ğŸ›¡ï¸ Shields: <span id="shieldCount">0</span></div>
          <div class="pill">ğŸ”¥ Streak: <span id="streakNumber">0</span></div>
        </div>

        <div class="btnrow">
          <button class="btn" id="openChaosBtn">ğŸŒ€ Chaos Reset (15 min)</button>
          <button class="btn" id="openShopBtn">ğŸ›ï¸ Dopamine Shop</button>
          <button class="btn" id="openLootBtn">ğŸ Loot Log</button>
          <button class="btn danger" id="hardResetBtn">Hard Reset</button>
        </div>
      </div>

      <div class="hint" id="dopamineText">
        Pick ONE tiny quest. We do not require perfection. We require existence.
      </div>

      <div class="pillrow" style="margin-top:10px;">
        <button class="btn" id="custodyMyBtn">ğŸ  My week w/ boys</button>
        <button class="btn" id="custodyDadBtn">ğŸš— Dadâ€™s week</button>
      </div>
    </div>

    <!-- Mode -->
    <div class="panel">
      <div class="toggles" id="modeToggle">
        <button class="toggleBtn active" data-mode="regular">âœ¨ Regular Mode</button>
        <button class="toggleBtn" data-mode="struggling">ğŸ’™ Bare Minimum</button>
      </div>
    </div>

    <!-- Frequency -->
    <div class="panel">
      <div class="toggles" id="freqToggle">
        <button class="toggleBtn active" data-freq="daily">ğŸŒ Daily</button>
        <button class="toggleBtn" data-freq="weekly">ğŸ“† Weekly</button>
        <button class="toggleBtn" data-freq="monthly">ğŸŒ™ Monthly</button>
        <button class="toggleBtn" data-freq="yearly">âœ¨ Yearly</button>
      </div>
    </div>

    <!-- Laundry Timer -->
    <div class="timerBox">
      <div style="font-family:'Fraunces',serif;font-size:1.2rem;font-weight:900;">ğŸ§º Laundry Timer</div>
      <div class="timerDisplay" id="timerDisplay">--:--</div>
      <div class="timerRow">
        <input class="timerInput" id="minutesInput" type="number" min="1" max="999" placeholder="Minutes (e.g., 45 or 60)" />
        <button class="btn primary" id="startTimerBtn">Start</button>
        <button class="btn" id="stopTimerBtn">Stop</button>
      </div>
      <div class="small">Pro tip: Washer 45, dryer 60, chaos unknown.</div>
    </div>

    <!-- Tasks -->
    <div class="taskGrid" id="taskGrid"></div>
  </div>

  <!-- Shop -->
  <div class="overlay" id="shopModal">
    <div class="modal">
      <div class="modalHead">
        <h2>ğŸ›ï¸ Dopamine Shop</h2>
        <button class="btn danger" id="closeShopBtn">Close</button>
      </div>
      <div class="modalHint">
        Spend coins on rewards. Buy shields to protect streaks for missed calendar days.
      </div>
      <div class="modalList">
        <button class="btn" id="buyShieldBtn">ğŸ›¡ï¸ Buy 1 Shield (25 coins)</button>

        <button class="btn shopItem" data-cost="15" data-label="â˜• Fancy drink token">â˜• Fancy drink token (15)</button>
        <button class="btn shopItem" data-cost="10" data-label="ğŸ« Sweet treat token">ğŸ« Sweet treat token (10)</button>
        <button class="btn shopItem" data-cost="20" data-label="ğŸ›‹ï¸ 20-min guilt-free rest">ğŸ›‹ï¸ 20-min guilt-free rest (20)</button>
        <button class="btn shopItem" data-cost="12" data-label="ğŸ§ Music + clean dance break">ğŸ§ Music + clean dance break (12)</button>
        <button class="btn shopItem" data-cost="18" data-label="ğŸ•¯ï¸ Cozy reset ritual">ğŸ•¯ï¸ Cozy reset ritual (18)</button>
      </div>
      <div class="small">
        Streak rule: consecutive calendar days where you did <strong>at least 1 Daily task</strong>.
        Missed a day? Shield can auto-save it.
      </div>
    </div>
  </div>

  <!-- Loot Log -->
  <div class="overlay" id="lootModal">
    <div class="modal">
      <div class="modalHead">
        <h2>ğŸ Loot Log</h2>
        <button class="btn danger" id="closeLootBtn">Close</button>
      </div>
      <div class="modalHint">Receipts for your brain. Wins count.</div>
      <div class="modalList" id="lootList"></div>
      <div class="small">Loot drops trigger when you complete a room (100%).</div>
    </div>
  </div>

  <!-- Chaos Portal -->
  <div class="overlay" id="chaosModal">
    <div class="modal">
      <div class="modalHead">
        <h2>ğŸŒ€ Chaos Portal</h2>
        <button class="btn danger" id="closeChaosBtn">Close</button>
      </div>
      <div class="modalHint" id="chaosIntro">
        Welcome, brave goblin. We will fight the mess dragon with a paper towel.
      </div>

      <div class="panel" style="margin-bottom:10px;">
        <div class="pillrow" style="justify-content:space-between;">
          <div class="pill">â³ Timer: <span id="chaosTimer">15:00</span></div>
          <div class="pill">ğŸ¯ Goal: <span id="chaosGoal">Contain the chaos</span></div>
        </div>
        <div class="pillrow" style="margin-top:10px;">
          <button class="btn primary" id="startChaosBtn">â–¶ Start</button>
          <button class="btn" id="pauseChaosBtn">â¸ Pause</button>
          <button class="btn" id="rerollChaosBtn">ğŸ² Reroll Plan</button>
        </div>
        <div class="small">Rule: You only do what the portal says. Brain doesnâ€™t get a vote.</div>
      </div>

      <div class="modalList" id="chaosPlan"></div>

      <div class="small">
        If you get distracted: return like a Roomba. No shame. Just bump back into the plan.
      </div>
    </div>
  </div>

<script>
/* ============================================================
   CHAOS CLEAN RPG â€” CALENDAR-BASED
   - Uses period keys: D:YYYY-MM-DD, W:YYYY-W##, M:YYYY-MM, Y:YYYY
   - Stores completions per period per category per task index
   ============================================================ */

/* -------------------- TASK CONTENT -------------------- */

const BASE_TASKS = {
  regular: {
    daily: {
      kitchen: { name: 'Kitchen', icon:'ğŸ³', color:'kitchen', tasks: [
        'Dishes contained (dishwasher or sink)',
        'Wipe counters + stove front',
        'Trash/recycling check',
        'Quick sweep (30â€“60 sec)'
      ]},
      living: { name: 'Living Areas', icon:'ğŸ›‹ï¸', color:'living', tasks: [
        '5-minute pickup (timer)',
        'Clear coffee table/surfaces',
        'Blankets + pillows reset',
        'Mail/papers into ONE pile'
      ]},
      entry: { name:'Entry + Mud Zone', icon:'ğŸšª', color:'entry', tasks: [
        'Shoes to one spot',
        'Coats/bags hung up',
        'Clear the floor (tiny)'
      ]},
      bathrooms: { name:'Bathrooms', icon:'ğŸ›', color:'bathrooms', tasks: [
        'Wipe sink/counter (fast)',
        'Quick toilet swish (30 sec)',
        'Towels hung up'
      ]},
      master: { name:'Master Suite', icon:'ğŸ‘‘', color:'master', tasks: [
        'Bed made (messy counts)',
        'Clothes in hamper',
        'Nightstands reset (one pass)'
      ]},
      laundry: { name:'Laundry', icon:'ğŸ§º', color:'laundry', tasks: [
        'One load started OR folded (choose one)',
        'Move washer â†’ dryer (if needed)',
        'Put away ONE pile (partial is fine)'
      ]}
    },

    weekly: {
      kitchen: { name:'Kitchen', icon:'ğŸ³', color:'kitchen', tasks: [
        'Microwave wipe + plate wash',
        'Sink scrub + faucet shine',
        'Wipe cabinet fronts (high touch)',
        'Sweep + mop (or Swiffer)'
      ]},
      living: { name:'Living Areas', icon:'ğŸ›‹ï¸', color:'living', tasks: [
        'Vacuum main areas',
        'Dust surfaces (fast pass)',
        'Glass/mirrors you see daily',
        'Couch cushion reset + under-cushion check'
      ]},
      entry: { name:'Entry + Mud Zone', icon:'ğŸšª', color:'entry', tasks: [
        'Sort shoes (current season)',
        'Wipe door handles',
        'Quick mop entry'
      ]},
      bathrooms: { name:'Bathrooms', icon:'ğŸ›', color:'bathrooms', tasks: [
        'Full toilet clean',
        'Mirror + sink scrub',
        'Tub/shower quick scrub',
        'Swap towels + bath mats'
      ]},
      master: { name:'Master Suite', icon:'ğŸ‘‘', color:'master', tasks: [
        'Change sheets',
        'Vacuum floor',
        'Trash out + mirror wipe'
      ]},
      laundry: { name:'Laundry', icon:'ğŸ§º', color:'laundry', tasks: [
        'Towels wash',
        'Bedding wash (at least one bed)',
        'Lint trap + wipe dryer top'
      ]},
      outside: { name:'Outside / Car', icon:'ğŸš—', color:'outside', tasks: [
        'Take trash/recycling out',
        'Car: remove obvious trash',
        'Porch/patio quick sweep'
      ]}
    },

    monthly: {
      kitchen: { name:'Kitchen', icon:'ğŸ³', color:'kitchen', tasks: [
        'Fridge shelf wipe + toss science projects',
        'Run dishwasher cleaner cycle',
        'Pantry purge: ONE shelf',
        'Wipe baseboards (kitchen)'
      ]},
      living: { name:'Living Areas', icon:'ğŸ›‹ï¸', color:'living', tasks: [
        'Vacuum couch + under cushions',
        'Wipe switches + remotes',
        'Windows quick clean (obvious ones)',
        'Dust vents (quick pass)'
      ]},
      bathrooms: { name:'Bathrooms', icon:'ğŸ›', color:'bathrooms', tasks: [
        'Shower deeper clean (pick ONE bath)',
        'Restock supplies',
        'Drain hair check'
      ]},
      master: { name:'Master Suite', icon:'ğŸ‘‘', color:'master', tasks: [
        'Closet sweep + donate bag',
        'Baseboards wipe'
      ]},
      laundry: { name:'Laundry', icon:'ğŸ§º', color:'laundry', tasks: [
        'Wipe washer gasket',
        'Wipe laundry shelf area',
        'Restock detergent/softener'
      ]},
      outside: { name:'Outside / Car', icon:'ğŸš—', color:'outside', tasks: [
        'Car: quick vacuum OR wipe dash',
        'Wipe outside door frames'
      ]}
    },

    yearly: {
      kitchen: { name:'Kitchen', icon:'ğŸ³', color:'kitchen', tasks: [
        'Clean oven (or outsource)',
        'Pull fridge/stove and vacuum behind',
        'Deep pantry purge'
      ]},
      living: { name:'Living Areas', icon:'ğŸ›‹ï¸', color:'living', tasks: [
        'Curtains wash / swap',
        'Carpet shampoo or deep vacuum day',
        'Deep dust fans/vents'
      ]},
      bathrooms: { name:'Bathrooms', icon:'ğŸ›', color:'bathrooms', tasks: [
        'Replace shower liner',
        'Grout/caulk check (only if needed)'
      ]},
      master: { name:'Master Suite', icon:'ğŸ‘‘', color:'master', tasks: [
        'Mattress rotate',
        'Under-bed purge'
      ]},
      laundry: { name:'Laundry', icon:'ğŸ§º', color:'laundry', tasks: [
        'Washer deep clean cycle',
        'Dryer vent deep clean'
      ]},
      outside: { name:'Outside / Home', icon:'ğŸ¡', color:'outside', tasks: [
        'Garage/closet purge day (ONE zone)',
        'Smoke detector batteries (if applicable)'
      ]}
    }
  },

  struggling: {
    daily: {
      essential: { name:'Bare Minimum', icon:'ğŸ’™', color:'living', tasks: [
        'Dishes contained (sink or dishwasher)',
        'Trash in a bag',
        'Laundry in hamper',
        'One surface cleared (any)',
        'STOP. Rest.'
      ]}
    },
    weekly: {
      essential: { name:'Bare Minimum', icon:'ğŸ’™', color:'living', tasks: [
        'Fresh sheets OR pillowcases',
        'One bathroom wipe',
        'One vacuum lane',
        'One load laundry'
      ]}
    },
    monthly: {
      essential: { name:'Bare Minimum', icon:'ğŸ’™', color:'living', tasks: [
        'Donate bag started',
        'Restock paper products'
      ]}
    },
    yearly: {
      essential: { name:'Bare Minimum', icon:'ğŸ’™', color:'living', tasks: [
        'One big reset day (pick a room)'
      ]}
    }
  }
};

const CUSTODY_TASKS = {
  my: {
    regular: {
      daily: {
        kids: { name:"Kids' Zones", icon:'ğŸš€', color:'kids', tasks: [
          'Cups/dishes return to kitchen',
          'Clothes to hamper',
          'Trash to bin',
          'One category put away (books/legos/random)'
        ]}
      },
      weekly: {
        kids: { name:"Kids' Zones", icon:'ğŸš€', color:'kids', tasks: [
          'Trash out',
          'Vacuum/sweep floor',
          'Desk/top surfaces wipe',
          'Re-home mystery cups (boss fight)'
        ]}
      },
      monthly: {
        kids: { name:"Kids' Zones", icon:'ğŸš€', color:'kids', tasks: [
          'Toy purge bucket (15 min)',
          'Sheets wash (again)',
          'Baseboards quick wipe'
        ]}
      },
      yearly: {
        kids: { name:"Kids' Zones", icon:'ğŸš€', color:'kids', tasks: [
          'Seasonal clothing swap',
          'Big lego/toy sort'
        ]}
      }
    }
  },

  dad: {
    regular: {
      daily: {
        kids: { name:"Reset & Prep (Dad Week)", icon:'ğŸ§¼', color:'kids', tasks: [
          'Contain kid clutter into ONE basket',
          'Wipe surfaces in kid zones (fast)',
          'Start a â€œreturn dayâ€ laundry pile',
          'Set out landing-zone items (backpacks/coats)'
        ]}
      },
      weekly: {
        kids: { name:"Reset & Prep (Dad Week)", icon:'ğŸ§¼', color:'kids', tasks: [
          'Sheets wash + remake beds',
          'Vacuum kid zones (full pass)',
          'Sort toys into ONE bin category',
          'Restock snacks/toiletries/basics'
        ]}
      },
      monthly: {
        kids: { name:"Reset & Prep (Dad Week)", icon:'ğŸ§¼', color:'kids', tasks: [
          'Donation bag: outgrown/clutter purge',
          'Wipe baseboards in kid zones',
          'Rotate seasonal items'
        ]}
      },
      yearly: {
        kids: { name:"Reset & Prep (Dad Week)", icon:'ğŸ§¼', color:'kids', tasks: [
          'Big kid-zone overhaul (one afternoon)',
          'Organize school papers (one box)'
        ]}
      }
    }
  }
};

/* -------------------- STATE -------------------- */

let currentMode = 'regular';
let currentFrequency = 'daily';

let timerInterval = null;
let timerEndTime = null;

let chaosInterval = null;
let chaosRemainingSeconds = 15 * 60;
let chaosRunning = false;

const STORAGE_KEY = 'chaosClean_v1';
const LOOT_LOG_KEY = 'chaosClean_loot';
const LOOTED_MAP_KEY = 'chaosClean_lootedMap';

/* -------------------- DOPAMINE & LOOT -------------------- */

const REWARDS = [
  "âœ¨ Nice. That counts. Your brain likes receipts.",
  "ğŸª„ You just cast 'Cleanus Minimus'. It's effective.",
  "ğŸ”¥ Momentum achieved. Tiny is mighty.",
  "ğŸ’ Dopamine acquired. Collect another?",
  "ğŸŒˆ Functional wizard energy detected.",
  "ğŸ§  Executive function cameo. Rare drop!"
];

const LOOT_TABLE = [
  { text: 'ğŸ¬ Candy drop', coins: 3 },
  { text: 'âœ¨ Sparkle boost', coins: 4 },
  { text: 'â˜• Coffee energy', coins: 5 },
  { text: 'ğŸ•¯ï¸ Cozy vibes', coins: 4 },
  { text: 'ğŸ¶ Cleaning anthem moment', coins: 3 },
  { text: 'ğŸ§  Executive function cameo', coins: 6 }
];

function dopamine(msg) {
  const el = document.getElementById('dopamineText');
  if (!el) return;
  el.textContent = msg || REWARDS[Math.floor(Math.random() * REWARDS.length)];
  popSparkles();
}

function popSparkles() {
  for (let i = 0; i < 14; i++) {
    const s = document.createElement('span');
    s.className = 'spark';
    s.textContent = ['âœ¨','ğŸ’«','â­','ğŸŒŸ'][Math.floor(Math.random()*4)];
    s.style.left = (50 + (Math.random()*70 - 35)) + '%';
    s.style.top = (25 + Math.random()*20) + '%';
    document.body.appendChild(s);
    setTimeout(() => s.remove(), 900);
  }
}

function playDing(type) {
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.connect(g); g.connect(ctx.destination);

    const now = ctx.currentTime;
    let freq = 880, dur = 0.08;
    if (type === 'loot')   { freq = 1046.5; dur = 0.12; }
    if (type === 'buy')    { freq = 659.25; dur = 0.10; }
    if (type === 'shield') { freq = 523.25; dur = 0.10; }
    if (type === 'nope')   { freq = 220.0; dur = 0.10; }
    if (type === 'portal') { freq = 740.0; dur = 0.12; }

    o.type = 'sine';
    o.frequency.setValueAtTime(freq, now);

    g.gain.setValueAtTime(0.0001, now);
    g.gain.exponentialRampToValueAtTime(0.25, now + 0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, now + dur);

    o.start(now); o.stop(now + dur + 0.02);
    setTimeout(() => ctx.close(), 240);
  } catch(e) {}
}

/* -------------------- DATE KEYS (CALENDAR-BASED) -------------------- */

function pad2(n){ return String(n).padStart(2,'0'); }
function ymd(d){
  return d.getFullYear() + '-' + pad2(d.getMonth()+1) + '-' + pad2(d.getDate());
}

// ISO week key: YYYY-W##
function weekKey(d){
  const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
  const dayNum = date.getUTCDay() || 7;
  date.setUTCDate(date.getUTCDate() + 4 - dayNum);
  const yearStart = new Date(Date.UTC(date.getUTCFullYear(), 0, 1));
  const weekNo = Math.ceil((((date - yearStart) / 86400000) + 1) / 7);
  return date.getUTCFullYear() + '-W' + pad2(weekNo);
}

function periodKey(freq, dateObj){
  const d = dateObj || new Date();
  if (freq === 'daily') return 'D:' + ymd(d);
  if (freq === 'weekly') return 'W:' + weekKey(d);
  if (freq === 'monthly') return 'M:' + d.getFullYear() + '-' + pad2(d.getMonth()+1);
  if (freq === 'yearly') return 'Y:' + d.getFullYear();
  return 'D:' + ymd(d);
}

/* -------------------- STORAGE -------------------- */

function loadData(){
  try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}'); }
  catch(e){ return {}; }
}
function saveData(data){
  try { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }
  catch(e){}
}

function getCoins(){ return parseInt(localStorage.getItem('coins') || '0', 10); }
function setCoins(n){ localStorage.setItem('coins', String(Math.max(0,n))); updateHUD(); }

function getShields(){ return parseInt(localStorage.getItem('shields') || '0', 10); }
function setShields(n){ localStorage.setItem('shields', String(Math.max(0,n))); updateHUD(); }

function getStreak(){ return parseInt(localStorage.getItem('streak') || '0', 10); }
function setStreak(n){ localStorage.setItem('streak', String(Math.max(0,n))); updateHUD(); }

function getCustody(){ return localStorage.getItem('custody') || 'my'; }
function setCustody(v){ localStorage.setItem('custody', v); updateHUD(); renderTasks(); }

function getLootLog(){
  try { return JSON.parse(localStorage.getItem(LOOT_LOG_KEY) || '[]'); }
  catch(e){ return []; }
}
function addLoot(entry){
  const log = getLootLog();
  log.unshift(entry);
  localStorage.setItem(LOOT_LOG_KEY, JSON.stringify(log.slice(0, 60)));
}

function getLootedMap(){
  try { return JSON.parse(localStorage.getItem(LOOTED_MAP_KEY) || '{}'); }
  catch(e){ return {}; }
}
function setLootedMap(obj){
  localStorage.setItem(LOOTED_MAP_KEY, JSON.stringify(obj));
}

function updateHUD(){
  document.getElementById('todayLabel').textContent = new Date().toLocaleDateString();
  document.getElementById('custodyLabel').textContent = (getCustody() === 'dad') ? "Dadâ€™s week" : "My week";
  document.getElementById('coinCount').textContent = String(getCoins());
  document.getElementById('shieldCount').textContent = String(getShields());
  document.getElementById('streakNumber').textContent = String(getStreak());
}

/* -------------------- TASK SET (BASE + CUSTODY OVERLAY) -------------------- */

function deepClone(obj){ return JSON.parse(JSON.stringify(obj)); }

function mergeTaskSets(baseSet, overlaySet){
  const out = deepClone(baseSet || {});
  const o = overlaySet || {};
  Object.keys(o).forEach(k => { out[k] = o[k]; });
  return out;
}

function effectiveTaskSet(){
  const base = (BASE_TASKS[currentMode] && BASE_TASKS[currentMode][currentFrequency])
    ? BASE_TASKS[currentMode][currentFrequency] : {};

  // only overlay kid tasks for regular mode
  if (currentMode !== 'regular') return base;

  const custody = getCustody();
  const overlay = (CUSTODY_TASKS[custody] &&
                   CUSTODY_TASKS[custody].regular &&
                   CUSTODY_TASKS[custody].regular[currentFrequency])
    ? CUSTODY_TASKS[custody].regular[currentFrequency] : {};

  return mergeTaskSets(base, overlay);
}

/* -------------------- COMPLETION -------------------- */

function isTaskDone(freq, category, index){
  const data = loadData();
  const key = periodKey(freq);
  return !!(data[key] && data[key][category] && data[key][category][index]);
}

function setTaskDone(freq, category, index, val){
  const data = loadData();
  const key = periodKey(freq);
  if (!data[key]) data[key] = {};
  if (!data[key][category]) data[key][category] = {};
  data[key][category][index] = !!val;
  saveData(data);
}

function roomProgress(freq, category, tasks){
  let done = 0;
  for (let i=0;i<tasks.length;i++){
    if (isTaskDone(freq, category, i)) done++;
  }
  const total = tasks.length;
  const pct = total ? Math.round((done/total)*100) : 0;
  return { done, total, pct };
}

/* -------------------- LOOT DROP WHEN ROOM COMPLETED -------------------- */

function maybeDropLoot(freq, category, taskSet){
  if (!taskSet[category]) return;

  const tasks = taskSet[category].tasks;
  const prog = roomProgress(freq, category, tasks);
  if (prog.pct < 100) return;

  const cycleKey = periodKey(freq);
  const lootKey = cycleKey + '::' + currentMode + '::' + category;

  const map = getLootedMap();
  if (map[lootKey]) return;

  map[lootKey] = true;
  setLootedMap(map);

  const drop = LOOT_TABLE[Math.floor(Math.random() * LOOT_TABLE.length)];
  setCoins(getCoins() + drop.coins);

  addLoot({
    title: `ğŸ Loot drop: ${drop.text} (+${drop.coins} coins) â€” ${taskSet[category].name} cleared!`,
    when: new Date().toLocaleString()
  });

  dopamine(`ğŸ LOOT DROP! ${drop.text} (+${drop.coins})`);
  playDing('loot');
}

/* -------------------- STREAK (CALENDAR) -------------------- */

function dayHadAnyDaily(dateObj){
  const data = loadData();
  const key = periodKey('daily', dateObj);
  const day = data[key];
  if (!day) return false;

  for (const cat in day){
    if (!Object.prototype.hasOwnProperty.call(day, cat)) continue;
    const obj = day[cat];
    for (const idx in obj){
      if (Object.prototype.hasOwnProperty.call(obj, idx) && obj[idx] === true) return true;
    }
  }
  return false;
}

function midnightDate(d){
  return new Date(d.getFullYear(), d.getMonth(), d.getDate());
}

function daysBetween(a,b){
  const aa = midnightDate(a);
  const bb = midnightDate(b);
  return Math.round((bb-aa)/86400000);
}

// Called on load, applies missed-day logic and shields
function reconcileStreak(){
  const last = localStorage.getItem('streakLastChecked');
  const today = new Date();
  const todayKey = ymd(today);

  if (!last){
    localStorage.setItem('streakLastChecked', todayKey);
    return;
  }
  if (last === todayKey) return;

  const prev = new Date(last + 'T12:00:00');
  const gap = daysBetween(prev, today);

  for (let i=1;i<=gap;i++){
    const checkDay = new Date(prev);
    checkDay.setDate(prev.getDate() + i);

    if (!dayHadAnyDaily(checkDay)){
      const shields = getShields();
      if (shields > 0){
        setShields(shields - 1);
        addLoot({ title:`ğŸ›¡ï¸ Shield used for ${checkDay.toLocaleDateString()}`, when:new Date().toLocaleString() });
        playDing('shield');
      } else {
        setStreak(0);
      }
    }
  }

  localStorage.setItem('streakLastChecked', todayKey);
}

// Only bump streak once per day, the first time you complete a daily task
function bumpStreakOnceToday(){
  const todayKey = ymd(new Date());
  const counted = localStorage.getItem('streakCountedFor') || '';
  if (counted === todayKey) return;

  setStreak(getStreak() === 0 ? 1 : getStreak() + 1);
  localStorage.setItem('streakCountedFor', todayKey);
}

/* -------------------- RENDER -------------------- */

function escapeHtml(str){
  return String(str)
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;')
    .replace(/'/g,'&#039;');
}

function createCard(freq, category, room){
  const card = document.createElement('div');
  card.className = 'taskCard ' + room.color;

  let items = '';
  for (let i=0;i<room.tasks.length;i++){
    const done = isTaskDone(freq, category, i);
    items += `
      <div class="taskItem ${done ? 'completed':''}"
           data-action="toggle"
           data-freq="${freq}"
           data-category="${category}"
           data-index="${i}">
        <div class="checkbox"></div>
        <div class="taskText">${escapeHtml(room.tasks[i])}</div>
      </div>
    `;
  }

  const prog = roomProgress(freq, category, room.tasks);

  card.innerHTML = `
    <div class="taskHeader">
      <div class="titleWrap">
        <div class="icon">${room.icon}</div>
        <h3>${escapeHtml(room.name)}</h3>
      </div>
      <div class="badge">${freq}</div>
    </div>

    <div class="taskList">${items}</div>

    <div class="progressSection">
      <div class="progressLabel">
        <span>Progress</span>
        <span>${prog.pct}%</span>
      </div>
      <div class="progressBar">
        <div class="progressFill" style="width:${prog.pct}%"></div>
      </div>
    </div>
  `;

  return card;
}

function renderTasks(){
  const grid = document.getElementById('taskGrid');
  grid.innerHTML = '';

  const set = effectiveTaskSet();
  const keys = Object.keys(set);

  if (keys.length === 0){
    grid.innerHTML = `<div class="panel">No tasks found for this mode/frequency.</div>`;
    return;
  }

  keys.forEach(cat => {
    grid.appendChild(createCard(currentFrequency, cat, set[cat]));
  });
}

/* -------------------- TOGGLE TASK -------------------- */

function toggleTask(freq, category, index){
  const was = isTaskDone(freq, category, index);
  const now = !was;

  setTaskDone(freq, category, index, now);

  if (now){
    setCoins(getCoins() + 1);
    playDing('buy');
    dopamine();

    if (freq === 'daily'){
      reconcileStreak();
      bumpStreakOnceToday();
    }
  }

  const set = effectiveTaskSet();
  renderTasks();
  maybeDropLoot(freq, category, set);
  updateHUD();
}

/* -------------------- MODE/FREQ -------------------- */

function setMode(mode){
  currentMode = mode;

  document.querySelectorAll('#modeToggle .toggleBtn').forEach(btn => btn.classList.remove('active'));
  document.querySelector(`#modeToggle .toggleBtn[data-mode="${mode}"]`).classList.add('active');

  dopamine(mode === 'regular'
    ? "âœ¨ Full schedule loaded. Pick ONE tiny win."
    : "ğŸ’™ Bare minimum mode. Tiny is mighty."
  );

  renderTasks();
}

function setFrequency(freq){
  currentFrequency = freq;

  document.querySelectorAll('#freqToggle .toggleBtn').forEach(btn => btn.classList.remove('active'));
  document.querySelector(`#freqToggle .toggleBtn[data-freq="${freq}"]`).classList.add('active');

  dopamine(`ğŸ§­ ${freq.toUpperCase()} quests loaded. Choose ONE.`);
  renderTasks();
}

/* -------------------- MODALS -------------------- */

function show(id){ document.getElementById(id).style.display = 'block'; }
function hide(id){ document.getElementById(id).style.display = 'none'; }

function openShop(){ show('shopModal'); }
function closeShop(){ hide('shopModal'); }

function openLoot(){
  renderLoot();
  show('lootModal');
}
function closeLoot(){ hide('lootModal'); }

function renderLoot(){
  const list = document.getElementById('lootList');
  list.innerHTML = '';

  const log = getLootLog();
  if (log.length === 0){
    list.innerHTML = `<div class="small">No loot yet. Clear a room to trigger a loot drop âœ¨</div>`;
    return;
  }

  log.forEach(item => {
    const div = document.createElement('div');
    div.className = 'lootCard';
    div.innerHTML = `
      <div style="font-weight:900;">${escapeHtml(item.title)}</div>
      <div class="small" style="margin-top:4px;">${escapeHtml(item.when)}</div>
    `;
    list.appendChild(div);
  });
}

/* -------------------- SHOP ACTIONS -------------------- */

function buyShield(){
  const c = getCoins();
  if (c < 25){
    dopamine("ğŸš« Not enough coins. Tiny quest first.");
    playDing('nope');
    return;
  }
  setCoins(c - 25);
  setShields(getShields() + 1);
  addLoot({ title:"ğŸ›¡ï¸ Bought 1 shield (-25 coins)", when:new Date().toLocaleString() });
  dopamine("ğŸ›¡ï¸ Shield acquired. Future you protected.");
  playDing('shield');
}

function buyReward(label, cost){
  const c = getCoins();
  if (c < cost){
    dopamine("ğŸš« Not enough coins. Tiny quest first.");
    playDing('nope');
    return;
  }
  setCoins(c - cost);
  addLoot({ title:`âœ… Redeemed: ${label} (-${cost} coins)`, when:new Date().toLocaleString() });
  dopamine(`âœ… Redeemed: ${label}. This is officially allowed.`);
  playDing('buy');
}

/* -------------------- LAUNDRY TIMER -------------------- */

function startTimerMinutes(){
  const raw = document.getElementById('minutesInput').value;
  const mins = parseInt(raw, 10);

  if (!mins || mins < 1){
    dopamine("â›” Put a number of minutes in the box, goblin.");
    playDing('nope');
    return;
  }

  const end = new Date();
  end.setMinutes(end.getMinutes() + mins);
  timerEndTime = end;

  if (timerInterval) clearInterval(timerInterval);
  timerInterval = setInterval(updateTimerDisplay, 1000);
  updateTimerDisplay();

  dopamine(`ğŸ§º Timer started: ${mins} minutes.`);
  playDing('buy');
}

function stopTimer(){
  if (timerInterval) clearInterval(timerInterval);
  timerInterval = null;
  timerEndTime = null;
  document.getElementById('timerDisplay').textContent = '--:--';
  dopamine("â¹ï¸ Timer stopped. We pivot. No shame.");
  playDing('buy');
}

function updateTimerDisplay(){
  if (!timerEndTime) return;

  const now = new Date();
  let diff = timerEndTime - now;

  if (diff <= 0){
    stopTimer();
    document.getElementById('timerDisplay').textContent = '00:00';
    alert('Laundry timer finished!');
    dopamine("ğŸ‰ Laundry level-up unlocked.");
    playDing('loot');
    return;
  }

  const minutes = Math.floor(diff / 60000);
  const seconds = Math.floor((diff % 60000) / 1000);

  document.getElementById('timerDisplay').textContent =
    (minutes < 10 ? '0':'') + minutes + ':' + (seconds < 10 ? '0':'') + seconds;
}

/* -------------------- CHAOS PORTAL -------------------- */

function openChaos(){
  buildChaosPlan();
  resetChaosTimer();
  show('chaosModal');
  playDing('portal');
  dopamine("ğŸŒ€ CHAOS PORTAL OPENED. You are the chosen goblin.");
}

function closeChaos(){
  pauseChaos();
  hide('chaosModal');
}

function formatMMSS(total){
  const m = Math.floor(total/60);
  const s = total % 60;
  return pad2(m) + ':' + pad2(s);
}

function resetChaosTimer(){
  pauseChaos();
  chaosRemainingSeconds = 15 * 60;
  chaosRunning = false;
  document.getElementById('chaosTimer').textContent = formatMMSS(chaosRemainingSeconds);
}

function startChaos(){
  if (chaosRunning) return;
  chaosRunning = true;
  playDing('portal');

  if (chaosInterval) clearInterval(chaosInterval);
  chaosInterval = setInterval(() => {
    if (!chaosRunning) return;

    chaosRemainingSeconds--;
    if (chaosRemainingSeconds <= 0){
      chaosRemainingSeconds = 0;
      document.getElementById('chaosTimer').textContent = '00:00';
      pauseChaos();

      setCoins(getCoins() + 5);
      addLoot({ title:"ğŸŒ€ Chaos Portal cleared (+5 coins)", when:new Date().toLocaleString() });
      dopamine("ğŸ† PORTAL CLOSED. You survived 15 minutes. LEGENDARY. (+5)");
      playDing('loot');
      updateHUD();
      return;
    }

    document.getElementById('chaosTimer').textContent = formatMMSS(chaosRemainingSeconds);
  }, 1000);

  document.getElementById('chaosIntro').textContent =
    "Portal timer running. If you drift: return like a Roomba. No thoughts. Just next step.";
}

function pauseChaos(){
  chaosRunning = false;
  if (chaosInterval) clearInterval(chaosInterval);
  chaosInterval = null;
}

function buildChaosPlan(){
  const taskSet = effectiveTaskSet();
  const weights = {
    kitchen: 100,
    bathrooms: 95,
    living: 88,
    entry: 80,
    laundry: 75,
    master: 60,
    kids: 55,
    outside: 35,
    essential: 98
  };

  const pool = [];
  Object.keys(taskSet).forEach(cat => {
    const room = taskSet[cat];
    const w = weights[cat] || 50;
    for (let i=0;i<room.tasks.length;i++){
      if (!isTaskDone(currentFrequency, cat, i)){
        pool.push({
          cat,
          roomName: room.name,
          icon: room.icon,
          idx: i,
          text: room.tasks[i],
          weight: w
        });
      }
    }
  });

  const intros = [
    "Summoning portal gremlinsâ€¦ okay theyâ€™re useless. Itâ€™s just you. Iconic.",
    "The mess dragon has been spotted. We attack its ankles with wipes.",
    "This is a low-budget heist movie. The heist is: putting things away.",
    "Welcome to the Cleaning Arena. The crowd is screaming. (Itâ€™s the laundry.)",
    "Your quest: restore order. Reward: peace. Side effect: dopamine."
  ];
  document.getElementById('chaosIntro').textContent = intros[Math.floor(Math.random()*intros.length)];

  const goals = [
    "Contain the chaos",
    "Make it less embarrassing",
    "Create one clean zone",
    "Stop the mess from breeding",
    "Future you deserves better"
  ];
  document.getElementById('chaosGoal').textContent = goals[Math.floor(Math.random()*goals.length)];

  const plan = document.getElementById('chaosPlan');
  plan.innerHTML = '';

  if (pool.length === 0){
    plan.innerHTML = `
      <div class="planStep">
        <div class="planNum">â˜…</div>
        <div>
          <div class="planTitle">ğŸ† You already cleared this dimension.</div>
          <div class="planSub">Do a 2-minute maintenance spell (wipe one surface) OR go rest like a champion.</div>
        </div>
      </div>
    `;
    return;
  }

  pool.sort((a,b) => (b.weight - a.weight) || (Math.random() - 0.5));
  const picked = pool.slice(0, Math.min(5, pool.length));

  const spells = [
    "Cast: Wipe-ius Maximus",
    "Perform: The Sacred Yeet (into the trash)",
    "Summon: Dish Containment Ritual",
    "Execute: The 60-Second Panic Sweep",
    "Activate: Laundry Teleportation Protocol"
  ];

  picked.forEach((item, n) => {
    const div = document.createElement('div');
    div.className = 'planStep';
    div.innerHTML = `
      <div class="planNum">${n+1}</div>
      <div style="flex:1;">
        <div class="planTitle">${escapeHtml(item.icon + ' ' + item.roomName)}: ${escapeHtml(item.text)}</div>
        <div class="planSub">${escapeHtml(spells[n] || 'Proceed with goblin confidence')} â€¢ 2â€“4 min max</div>
      </div>
      <button class="btn primary"
              data-action="chaosDone"
              data-category="${item.cat}"
              data-index="${item.idx}">
        âœ… Mark Done
      </button>
    `;
    plan.appendChild(div);
  });

  const bonus = document.createElement('div');
  bonus.className = 'planStep';
  bonus.innerHTML = `
    <div class="planNum">â˜…</div>
    <div>
      <div class="planTitle">ğŸ§º Bonus Spell: â€œContainment Basketâ€</div>
      <div class="planSub">If your brain melts, throw loose items into ONE basket. Sorting is Future Youâ€™s problem.</div>
    </div>
  `;
  plan.appendChild(bonus);
}

function chaosMarkDone(category, index){
  if (!isTaskDone(currentFrequency, category, index)){
    setTaskDone(currentFrequency, category, index, true);
    setCoins(getCoins() + 1);
    playDing('buy');
    dopamine("âœ… Portal approves. One enemy slain. (+1 coin)");

    if (currentFrequency === 'daily'){
      reconcileStreak();
      bumpStreakOnceToday();
    }

    renderTasks();
    updateHUD();
    buildChaosPlan();
  } else {
    dopamine("ğŸ˜¤ That one is already dead. Choose a new foe.");
    playDing('nope');
  }
}

/* -------------------- HARD RESET -------------------- */

function hardReset(){
  if (!confirm("Hard reset EVERYTHING? This clears tasks, coins, shields, streak, loot log.")) return;

  localStorage.removeItem(STORAGE_KEY);
  localStorage.removeItem(LOOT_LOG_KEY);
  localStorage.removeItem(LOOTED_MAP_KEY);

  localStorage.removeItem('coins');
  localStorage.removeItem('shields');
  localStorage.removeItem('streak');
  localStorage.removeItem('custody');

  localStorage.removeItem('streakLastChecked');
  localStorage.removeItem('streakCountedFor');

  updateHUD();
  renderTasks();
  dopamine("ğŸ§¼ Hard reset complete. Fresh slate. Tiny quest time.");
}

/* -------------------- EVENT WIRING -------------------- */

function wire(){
  // mode toggle
  document.querySelectorAll('#modeToggle .toggleBtn').forEach(btn => {
    btn.addEventListener('click', () => setMode(btn.dataset.mode));
  });

  // frequency toggle
  document.querySelectorAll('#freqToggle .toggleBtn').forEach(btn => {
    btn.addEventListener('click', () => setFrequency(btn.dataset.freq));
  });

  // custody
  document.getElementById('custodyMyBtn').addEventListener('click', () => {
    setCustody('my');
    dopamine("ğŸ  My week selected. Kid-mess quests unlocked.");
    playDing('buy');
  });
  document.getElementById('custodyDadBtn').addEventListener('click', () => {
    setCustody('dad');
    dopamine("ğŸš— Dadâ€™s week selected. Reset-mode quests unlocked.");
    playDing('buy');
  });

  // timer
  document.getElementById('startTimerBtn').addEventListener('click', startTimerMinutes);
  document.getElementById('stopTimerBtn').addEventListener('click', stopTimer);
  document.getElementById('minutesInput').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') startTimerMinutes();
  });

  // modals
  document.getElementById('openShopBtn').addEventListener('click', openShop);
  document.getElementById('closeShopBtn').addEventListener('click', closeShop);

  document.getElementById('openLootBtn').addEventListener('click', openLoot);
  document.getElementById('closeLootBtn').addEventListener('click', closeLoot);

  document.getElementById('openChaosBtn').addEventListener('click', openChaos);
  document.getElementById('closeChaosBtn').addEventListener('click', closeChaos);

  document.getElementById('startChaosBtn').addEventListener('click', startChaos);
  document.getElementById('pauseChaosBtn').addEventListener('click', () => {
    pauseChaos();
    dopamine("â¸ï¸ Portal paused. We are strategic goblins.");
    playDing('buy');
  });
  document.getElementById('rerollChaosBtn').addEventListener('click', () => {
    buildChaosPlan();
    resetChaosTimer();
    dopamine("ğŸ² Rerolled. New enemies selected. Letâ€™s go.");
    playDing('portal');
  });

  // shop actions
  document.getElementById('buyShieldBtn').addEventListener('click', buyShield);
  document.querySelectorAll('.shopItem').forEach(btn => {
    btn.addEventListener('click', () => {
      const cost = parseInt(btn.dataset.cost, 10);
      const label = btn.dataset.label;
      buyReward(label, cost);
    });
  });

  // hard reset
  document.getElementById('hardResetBtn').addEventListener('click', hardReset);

  // delegated task clicks
  document.body.addEventListener('click', (e) => {
    let el = e.target;

    while (el && el !== document.body) {
      if (el.dataset && el.dataset.action === 'toggle') {
        toggleTask(el.dataset.freq, el.dataset.category, parseInt(el.dataset.index,10));
        return;
      }
      if (el.dataset && el.dataset.action === 'chaosDone') {
        chaosMarkDone(el.dataset.category, parseInt(el.dataset.index,10));
        return;
      }
      el = el.parentNode;
    }
  });
}

/* -------------------- INIT -------------------- */

document.addEventListener('DOMContentLoaded', () => {
  updateHUD();
  wire();
  reconcileStreak();
  renderTasks();
  dopamine("âœ¨ Loaded. Pick ONE tiny quest. Coins appear. Magic happens.");
});
</script>
</body>
</html>
