<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Cleaning Tracker</title>

  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Fraunces:wght@600;700;900&display=swap" rel="stylesheet">

  <style>
    :root {
      --daily: #60A5FA;
      --kitchen: #FCD34D;
      --bathrooms: #67E8F9;
      --master: #EC4899;
      --boys: #F9A8D4;
      --living: #60A5FA;
      --basement: #A78BFA;
      --bg: #0F172A;
      --surface: #1E293B;
      --text: #F1F5F9;
      --text-dim: #94A3B8;
      --success: #10B981;
      --danger: #EF4444;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'DM Sans', sans-serif;
      background: linear-gradient(135deg, #0F172A 0%, #1E293B 100%);
      color: var(--text);
      min-height: 100vh;
      padding: 20px;
      padding-bottom: 110px;
    }

    .container { max-width: 1400px; margin: 0 auto; }

    h1 {
      font-family: 'Fraunces', serif;
      font-size: 2.5rem;
      font-weight: 900;
      background: linear-gradient(135deg, #60A5FA 0%, #A78BFA 50%, #EC4899 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 10px;
    }

    .tagline { color: var(--text-dim); font-size: 1rem; margin-bottom: 18px; }

    .panel {
      background: var(--surface);
      border-radius: 20px;
      padding: 18px;
      margin-bottom: 16px;
      border: 1px solid rgba(255,255,255,0.08);
    }

    .topbar {
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
      margin-bottom: 10px;
    }

    .pillrow {
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }

    .pill {
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.12);
      padding: 8px 12px;
      border-radius: 999px;
      font-weight: 900;
    }

    .pill span { color: #FCD34D; }

    .mode-toggle { display: flex; gap: 10px; margin-bottom: 14px; flex-wrap: wrap; }

    .mode-btn {
      flex: 1;
      min-width: 180px;
      padding: 12px;
      background: rgba(255,255,255,0.06);
      border: 2px solid transparent;
      border-radius: 12px;
      color: var(--text);
      font-weight: 800;
      cursor: pointer;
    }

    .mode-btn.active { background: var(--daily); color: var(--bg); }

    .task-grid { display: grid; gap: 20px; }

    .task-card {
      background: var(--surface);
      border-radius: 15px;
      padding: 20px;
      border-top: 4px solid;
      border: 1px solid rgba(255,255,255,0.08);
    }

    .task-card.kitchen { border-top-color: var(--kitchen); }
    .task-card.bathrooms { border-top-color: var(--bathrooms); }
    .task-card.master { border-top-color: var(--master); }
    .task-card.boys { border-top-color: var(--boys); }
    .task-card.living { border-top-color: var(--living); }
    .task-card.basement { border-top-color: var(--basement); }

    .task-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      gap: 12px;
    }

    .task-title { display: flex; align-items: center; gap: 10px; }
    .task-icon { font-size: 1.5rem; }
    .task-title h3 { font-size: 1.25rem; }

    .task-badge {
      padding: 6px 12px;
      border-radius: 15px;
      font-size: 0.75rem;
      background: var(--daily);
      color: var(--bg);
      font-weight: 900;
      letter-spacing: 0.04em;
    }

    .task-list { display: flex; flex-direction: column; gap: 10px; }

    .task-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      background: rgba(255,255,255,0.05);
      border-radius: 10px;
      cursor: pointer;
      user-select: none;
    }

    .task-item:hover { background: rgba(255,255,255,0.075); }
    .task-item:active { background: rgba(255,255,255,0.12); }

    .checkbox {
      width: 24px;
      height: 24px;
      border: 2px solid var(--text-dim);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .task-item.completed .checkbox { background: var(--success); border-color: var(--success); }
    .task-item.completed .checkbox::after { content: 'âœ“'; color: white; font-weight: bold; }
    .task-item.completed .task-text { text-decoration: line-through; opacity: 0.65; }

    .task-text { flex: 1; font-size: 0.95rem; }

    .progress-section {
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid rgba(255,255,255,0.1);
    }

    .progress-label {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 0.85rem;
      color: var(--text-dim);
    }

    .progress-bar {
      height: 10px;
      background: rgba(255,255,255,0.1);
      border-radius: 10px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: var(--success);
      border-radius: 10px;
      transition: width 0.25s ease;
    }

    .laundry-timer {
      background: var(--basement);
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 16px;
      border: 1px solid rgba(255,255,255,0.12);
    }

    .timer-display {
      font-size: 2.5rem;
      font-weight: 900;
      text-align: center;
      margin: 15px 0;
    }

    .timer-buttons { display: flex; gap: 10px; flex-wrap: wrap; }

    .btn {
      flex: 1;
      min-width: 160px;
      padding: 12px;
      background: rgba(255,255,255,0.2);
      border: none;
      border-radius: 10px;
      color: white;
      font-weight: 900;
      cursor: pointer;
    }

    .btn:active { background: rgba(255,255,255,0.3); }

    .danger {
      background: var(--danger) !important;
    }

    /* Sparkles */
    .spark {
      position: fixed;
      font-size: 18px;
      pointer-events: none;
      animation: sparkPop 0.9s ease-out forwards;
      z-index: 99999;
    }
    @keyframes sparkPop {
      0% { transform: translate(-50%, 0) scale(0.6); opacity: 0; }
      20% { opacity: 1; }
      100% { transform: translate(-50%, -120px) scale(1.3); opacity: 0; }
    }

    /* Modal */
    .modalOverlay {
      display:none;
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.6);
      z-index:9999;
      padding:20px;
    }
    .modal {
      max-width: 700px;
      margin: 60px auto;
      background: var(--surface);
      border-radius: 16px;
      padding: 18px;
      border: 1px solid rgba(255,255,255,0.12);
    }
    .modalTitle {
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom: 8px;
    }
    .modalTitle h2 { font-family: 'Fraunces', serif; font-size: 1.5rem; }
    .modalHint { color: var(--text-dim); margin-bottom: 12px; }
    .modalList { display:grid; gap:10px; }
    .small { font-size: 0.9rem; color: var(--text-dim); line-height: 1.35; }

    @media (max-width: 768px) {
      h1 { font-size: 2rem; }
      .mode-btn { min-width: 140px; }
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <h1>âœ¨ Clean House, Clear Mind</h1>
      <p class="tagline">ADHD-friendly cleaning companion (calendar-based âœ¨)</p>
    </header>

    <!-- HUD -->
    <div class="panel">
      <div class="topbar">
        <div class="pillrow">
          <div class="pill">ğŸ“… Today: <span id="todayLabel">â€”</span></div>
          <div class="pill">ğŸª™ Coins: <span id="coinCount">0</span></div>
          <div class="pill">ğŸ›¡ï¸ Shields: <span id="shieldCount">0</span></div>
          <div class="pill">ğŸ”¥ Streak: <span id="streakNumber">0</span></div>
        </div>
        <div class="pillrow">
          <button class="btn" id="openShopBtn">ğŸ›ï¸ Dopamine Shop</button>
          <button class="btn" id="openLootBtn">ğŸ Loot Log</button>
          <button class="btn danger" id="hardResetBtn">Hard Reset</button>
        </div>
      </div>

      <div id="dopamineText" class="small">
        Pick ONE tiny quest. Coins happen. Magic happens.
      </div>
    </div>

    <!-- Mode -->
    <div class="mode-toggle" id="modeToggle">
      <button class="mode-btn active" data-mode="regular">âœ¨ Regular Mode</button>
      <button class="mode-btn" data-mode="struggling">ğŸ’™ Bare Minimum</button>
    </div>

    <!-- Frequency -->
    <div class="mode-toggle" id="freqToggle">
      <button class="mode-btn active" data-freq="daily">ğŸŒ Daily</button>
      <button class="mode-btn" data-freq="weekly">ğŸ“† Weekly</button>
      <button class="mode-btn" data-freq="monthly">ğŸŒ™ Monthly</button>
      <button class="mode-btn" data-freq="yearly">âœ¨ Yearly</button>
    </div>

    <!-- Laundry timer -->
    <div class="laundry-timer">
      <h3 style="font-family:'Fraunces', serif;">ğŸ§º Laundry Timer</h3>
      <div class="timer-display" id="timerDisplay">--:--</div>
      <div class="timer-buttons">
        <button class="btn" id="washerBtn">Washer 45m</button>
        <button class="btn" id="dryerBtn">Dryer 60m</button>
        <button class="btn" id="stopTimerBtn">Stop</button>
      </div>
    </div>

    <!-- Tasks -->
    <div class="task-grid" id="taskGrid"></div>
  </div>

  <!-- Shop Modal -->
  <div class="modalOverlay" id="shopModal">
    <div class="modal">
      <div class="modalTitle">
        <h2>ğŸ›ï¸ Dopamine Shop</h2>
        <button class="btn danger" id="closeShopBtn" style="min-width:auto;">Close</button>
      </div>
      <div class="modalHint">Spend coins on rewards. Buy shields to protect streaks (for missed days).</div>

      <div class="modalList">
        <button class="btn" id="buyShieldBtn">ğŸ›¡ï¸ Buy 1 Shield (25 coins)</button>
        <button class="btn shopItem" data-cost="15" data-label="â˜• Fancy drink token">â˜• Fancy drink token (15)</button>
        <button class="btn shopItem" data-cost="10" data-label="ğŸ« Sweet treat token">ğŸ« Sweet treat token (10)</button>
        <button class="btn shopItem" data-cost="20" data-label="ğŸ›‹ï¸ 20-min guilt-free rest">ğŸ›‹ï¸ 20-min guilt-free rest (20)</button>
        <button class="btn shopItem" data-cost="12" data-label="ğŸ§ Music + clean dance break">ğŸ§ Music + clean dance break (12)</button>
        <button class="btn shopItem" data-cost="18" data-label="ğŸ•¯ï¸ Cozy reset ritual">ğŸ•¯ï¸ Cozy reset ritual (18)</button>
      </div>

      <div class="small" style="margin-top: 12px;">
        Streak rule: If you completed <strong>at least 1 Daily task</strong> yesterday, your streak continues.
        If not, a shield can save it. Otherwise it resets. No shameâ€”just mechanics.
      </div>
    </div>
  </div>

  <!-- Loot Log Modal -->
  <div class="modalOverlay" id="lootModal">
    <div class="modal">
      <div class="modalTitle">
        <h2>ğŸ Loot Log</h2>
        <button class="btn danger" id="closeLootBtn" style="min-width:auto;">Close</button>
      </div>
      <div class="modalHint">Receipts for your brain. Wins are real.</div>
      <div id="lootList" class="modalList"></div>
      <div class="small" style="margin-top: 12px;">
        Loot drops happen when you complete a room (100% progress) for the current time period.
      </div>
    </div>
  </div>

  <script>
    // -------------------- TASK DATA --------------------
    var TASKS = {
      regular: {
        daily: {
          kitchen: { name: 'Kitchen', icon: 'ğŸ³', color: 'kitchen', tasks: [
            'Wipe counters + stove', 'Load/run dishwasher', 'Trash check', 'Table wipe'
          ]},
          living: { name: 'Living Areas', icon: 'ğŸ›‹ï¸', color: 'living', tasks: [
            '5-minute pickup', 'Clear coffee table', 'Fluff couch pillows', 'Main floor litter bag'
          ]},
          master: { name: 'Master Suite', icon: 'ğŸ‘‘', color: 'master', tasks: [
            'Make bed (ish)', 'Clothes in hamper', 'Nightstands reset'
          ]},
          boys: { name: "Boys' Rooms", icon: 'ğŸš€', color: 'boys', tasks: [
            "Freddie bed (ish)", "Henry bed (ish)", 'Clothes in hampers', 'Floor sweep (1 min)'
          ]},
          bathrooms: { name: 'Bathrooms', icon: 'ğŸ›', color: 'bathrooms', tasks: [
            'Wipe counters', 'Quick toilet swish', 'Hang towels'
          ]},
          laundry: { name: 'Laundry', icon: 'ğŸ§º', color: 'basement', tasks: [
            'One load started', 'Move washer â†’ dryer', 'Fold ONE basket'
          ]}
        },

        weekly: {
          kitchen: { name: 'Kitchen', icon: 'ğŸ³', color: 'kitchen', tasks: [
            'Clean microwave', 'Wipe cabinet fronts', 'Fridge shelf quick wipe', 'Sweep + mop'
          ]},
          living: { name: 'Living Areas', icon: 'ğŸ›‹ï¸', color: 'living', tasks: [
            'Vacuum main areas', 'Dust surfaces', 'Couch blanket wash', 'Entryway reset'
          ]},
          master: { name: 'Master Suite', icon: 'ğŸ‘‘', color: 'master', tasks: [
            'Change sheets', 'Vacuum', 'Mirror wipe'
          ]},
          boys: { name: "Boys' Rooms", icon: 'ğŸš€', color: 'boys', tasks: [
            'Trash out', 'Vacuum', 'Desk/top surfaces wipe'
          ]},
          bathrooms: { name: 'Bathrooms', icon: 'ğŸ›', color: 'bathrooms', tasks: [
            'Full toilet clean', 'Mirror + sink scrub', 'Replace towels', 'Swap bath mats'
          ]},
          laundry: { name: 'Laundry', icon: 'ğŸ§º', color: 'basement', tasks: [
            'Wash towels', 'Wash bedding', 'Lint trap + wipe dryer top'
          ]}
        },

        monthly: {
          kitchen: { name: 'Kitchen', icon: 'ğŸ³', color: 'kitchen', tasks: [
            'Deep clean fridge (15 min)', 'Run dishwasher cleaner', 'Wipe baseboards'
          ]},
          living: { name: 'Living Areas', icon: 'ğŸ›‹ï¸', color: 'living', tasks: [
            'Vacuum couch + under cushions', 'Wipe light switches', 'Windows quick clean'
          ]},
          master: { name: 'Master Suite', icon: 'ğŸ‘‘', color: 'master', tasks: [
            'Closet sweep + donate bag', 'Wipe baseboards'
          ]},
          boys: { name: "Boys' Rooms", icon: 'ğŸš€', color: 'boys', tasks: [
            'Toy purge bucket', 'Sheets wash (again)', 'Baseboards quick wipe'
          ]},
          bathrooms: { name: 'Bathrooms', icon: 'ğŸ›', color: 'bathrooms', tasks: [
            'Shower deep clean', 'Restock supplies', 'Drain hair check'
          ]},
          laundry: { name: 'Laundry', icon: 'ğŸ§º', color: 'basement', tasks: [
            'Wipe washer gasket', 'Clean dryer vent area', 'Restock detergent'
          ]}
        },

        yearly: {
          kitchen: { name: 'Kitchen', icon: 'ğŸ³', color: 'kitchen', tasks: [
            'Clean oven', 'Pull fridge, vacuum coils', 'Pantry purge'
          ]},
          living: { name: 'Living Areas', icon: 'ğŸ›‹ï¸', color: 'living', tasks: [
            'Curtains wash', 'Carpet shampoo / deep vacuum', 'Deep dust vents'
          ]},
          master: { name: 'Master Suite', icon: 'ğŸ‘‘', color: 'master', tasks: [
            'Mattress rotate', 'Under-bed purge'
          ]},
          boys: { name: "Boys' Rooms", icon: 'ğŸš€', color: 'boys', tasks: [
            'Seasonal clothing swap', 'Big toy/lego sort'
          ]},
          bathrooms: { name: 'Bathrooms', icon: 'ğŸ›', color: 'bathrooms', tasks: [
            'Replace shower liner', 'Grout touch-up (if needed)'
          ]},
          laundry: { name: 'Laundry', icon: 'ğŸ§º', color: 'basement', tasks: [
            'Washer deep clean cycle', 'Dryer vent deep clean'
          ]}
        }
      },

      struggling: {
        daily: {
          essential: { name: 'Bare Minimum', icon: 'ğŸ’™', color: 'living', tasks: [
            'Dishes contained (sink or dishwasher)',
            'Trash in a bag',
            'Laundry in hamper',
            'Litter bags changed',
            'STOP. Rest.'
          ]}
        },
        weekly: {
          essential: { name: 'Bare Minimum', icon: 'ğŸ’™', color: 'living', tasks: [
            'Fresh sheets OR pillowcases',
            'One bathroom wipe',
            'One vacuum lane',
            'One load laundry'
          ]}
        },
        monthly: {
          essential: { name: 'Bare Minimum', icon: 'ğŸ’™', color: 'living', tasks: [
            'Donate bag started',
            'Restock paper products'
          ]}
        },
        yearly: {
          essential: { name: 'Bare Minimum', icon: 'ğŸ’™', color: 'living', tasks: [
            'One big reset day (pick a room)'
          ]}
        }
      }
    };

    // -------------------- STATE --------------------
    var currentMode = 'regular';
    var currentFrequency = 'daily';

    var timerInterval = null;
    var timerEndTime = null;

    // -------------------- DOPAMINE --------------------
    var REWARDS = [
      "âœ¨ Nice. That counts. Your brain likes receipts.",
      "ğŸª„ You just cast 'Cleanus Minimus'. It's effective.",
      "ğŸ”¥ Momentum achieved. Keep going â€” tiny is mighty.",
      "ğŸ’ Dopamine acquired. Collect another?",
      "ğŸŒˆ Look at you being a functional wizard.",
      "ğŸ§  Executive function cameo. Rare drop!"
    ];

    var LOOT_TABLE = [
      { text: 'ğŸ¬ Candy drop', coins: 3 },
      { text: 'âœ¨ Sparkle boost', coins: 4 },
      { text: 'â˜• Coffee energy', coins: 5 },
      { text: 'ğŸ•¯ï¸ Cozy vibes', coins: 4 },
      { text: 'ğŸ¶ Cleaning anthem moment', coins: 3 },
      { text: 'ğŸ§  Executive function cameo', coins: 6 }
    ];

    function dopamine(msg) {
      var el = document.getElementById('dopamineText');
      if (!el) return;
      el.textContent = msg || REWARDS[Math.floor(Math.random() * REWARDS.length)];
      popConfetti();
    }

    function popConfetti() {
      for (var i = 0; i < 14; i++) {
        var s = document.createElement('span');
        s.className = 'spark';
        s.textContent = ['âœ¨','ğŸ’«','â­','ğŸŒŸ'][Math.floor(Math.random()*4)];
        s.style.left = (50 + (Math.random()*70 - 35)) + '%';
        s.style.top = (25 + Math.random()*20) + '%';
        document.body.appendChild(s);
        (function(node){ setTimeout(function(){ node.remove(); }, 900); })(s);
      }
    }

    // -------------------- AUDIO --------------------
    function playDing(type) {
      try {
        var ctx = new (window.AudioContext || window.webkitAudioContext)();
        var o = ctx.createOscillator();
        var g = ctx.createGain();
        o.connect(g);
        g.connect(ctx.destination);

        var now = ctx.currentTime;
        var freq = 880;
        var dur = 0.08;

        if (type === 'task')   { freq = 880; dur = 0.07; }
        if (type === 'loot')   { freq = 1046.5; dur = 0.12; }
        if (type === 'buy')    { freq = 659.25; dur = 0.10; }
        if (type === 'shield') { freq = 523.25; dur = 0.10; }
        if (type === 'nope')   { freq = 220; dur = 0.10; }

        o.type = 'sine';
        o.frequency.setValueAtTime(freq, now);

        g.gain.setValueAtTime(0.0001, now);
        g.gain.exponentialRampToValueAtTime(0.25, now + 0.01);
        g.gain.exponentialRampToValueAtTime(0.0001, now + dur);

        o.start(now);
        o.stop(now + dur + 0.02);
        setTimeout(function(){ ctx.close(); }, 250);
      } catch(e) {}
    }

    // -------------------- DATE KEYS (CALENDAR-BASED) --------------------
    function ymd(d) {
      var yyyy = d.getFullYear();
      var mm = String(d.getMonth() + 1).padStart(2, '0');
      var dd = String(d.getDate()).padStart(2, '0');
      return yyyy + '-' + mm + '-' + dd;
    }

    function getWeekKey(d) {
      // ISO-ish week key: YYYY-W##
      var date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
      var dayNum = date.getUTCDay() || 7;
      date.setUTCDate(date.getUTCDate() + 4 - dayNum);
      var yearStart = new Date(Date.UTC(date.getUTCFullYear(), 0, 1));
      var weekNo = Math.ceil((((date - yearStart) / 86400000) + 1) / 7);
      return date.getUTCFullYear() + '-W' + String(weekNo).padStart(2, '0');
    }

    function getPeriodKey(freq, dateObj) {
      var d = dateObj || new Date();
      if (freq === 'daily')   return 'D:' + ymd(d);
      if (freq === 'weekly')  return 'W:' + getWeekKey(d);
      if (freq === 'monthly') return 'M:' + d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0');
      if (freq === 'yearly')  return 'Y:' + d.getFullYear();
      return 'D:' + ymd(d);
    }

    // -------------------- STORAGE HELPERS --------------------
    function loadData() {
      try { return JSON.parse(localStorage.getItem('cleaningTasksV4') || '{}'); }
      catch(e) { return {}; }
    }

    function saveData(data) {
      try { localStorage.setItem('cleaningTasksV4', JSON.stringify(data)); } catch(e) {}
    }

    function getCoins() { return parseInt(localStorage.getItem('coins') || '0', 10); }
    function setCoins(n) { localStorage.setItem('coins', String(Math.max(0, n))); updateHUD(); }

    function getShields() { return parseInt(localStorage.getItem('shields') || '0', 10); }
    function setShields(n) { localStorage.setItem('shields', String(Math.max(0, n))); updateHUD(); }

    function getStreak() { return parseInt(localStorage.getItem('cleaningStreak') || '0', 10); }
    function setStreak(n) { localStorage.setItem('cleaningStreak', String(Math.max(0, n))); updateHUD(); }

    function getLootLog() {
      try { return JSON.parse(localStorage.getItem('lootLog') || '[]'); } catch(e) { return []; }
    }
    function addLootLog(entry) {
      var log = getLootLog();
      log.unshift(entry);
      log = log.slice(0, 60);
      localStorage.setItem('lootLog', JSON.stringify(log));
    }

    function getRoomLootedMap() {
      try { return JSON.parse(localStorage.getItem('roomLootedMap') || '{}'); } catch(e) { return {}; }
    }
    function setRoomLootedMap(obj) { localStorage.setItem('roomLootedMap', JSON.stringify(obj)); }

    function updateHUD() {
      document.getElementById('coinCount').textContent = String(getCoins());
      document.getElementById('shieldCount').textContent = String(getShields());
      document.getElementById('streakNumber').textContent = String(getStreak());
      document.getElementById('todayLabel').textContent = new Date().toLocaleDateString();
    }

    // -------------------- STREAK (CALENDAR-BASED) --------------------
    // Rule: streak counts consecutive calendar days where you completed at least 1 DAILY task.
    // If you miss a day, a shield can cover it (one shield per missed day, used automatically).
    function dayHadAnyDailyTask(dateObj) {
      var data = loadData();
      var key = getPeriodKey('daily', dateObj);
      var dayData = data[key];
      if (!dayData) return false;

      for (var cat in dayData) {
        if (!dayData.hasOwnProperty(cat)) continue;
        var obj = dayData[cat];
        for (var idx in obj) {
          if (obj.hasOwnProperty(idx) && obj[idx] === true) return true;
        }
      }
      return false;
    }

    function daysBetween(a, b) {
      // whole-day diff between dates (local midnight)
      var aa = new Date(a.getFullYear(), a.getMonth(), a.getDate());
      var bb = new Date(b.getFullYear(), b.getMonth(), b.getDate());
      return Math.round((bb - aa) / 86400000);
    }

    function reconcileStreak() {
      // Called on load and after completing a task.
      var lastChecked = localStorage.getItem('streakLastChecked'); // ymd
      var today = new Date();
      var todayKey = ymd(today);

      if (!lastChecked) {
        localStorage.setItem('streakLastChecked', todayKey);
        // don't auto change streak on first run; just keep what user has
        return;
      }

      if (lastChecked === todayKey) return;

      var prev = new Date(lastChecked + 'T12:00:00'); // safe parse
      var gap = daysBetween(prev, today); // number of days since last check

      // Walk through each missing day
      for (var i = 1; i <= gap; i++) {
        var checkDay = new Date(prev);
        checkDay.setDate(prev.getDate() + i);

        // if we already have daily completion that day: streak continues naturally
        // if not, try shield; if none, streak resets to 0
        if (!dayHadAnyDailyTask(checkDay)) {
          var shields = getShields();
          if (shields > 0) {
            setShields(shields - 1);
            addLootLog({ title: "ğŸ›¡ï¸ Shield used to protect streak for " + checkDay.toLocaleDateString(), when: new Date().toLocaleString() });
          } else {
            setStreak(0);
          }
        }
      }

      localStorage.setItem('streakLastChecked', todayKey);
      updateHUD();
    }

    function bumpStreakIfNeededToday() {
      // If user completes their first daily task of the day, and yesterday was valid, streak increments.
      // We only increment once per day.
      var today = new Date();
      var todayY = ymd(today);

      var already = localStorage.getItem('streakCountedFor') || '';
      if (already === todayY) return;

      // If streak is 0, set to 1 when first daily task happens.
      // If streak > 0, we still set "counted" to prevent multiple increments.
      var current = getStreak();
      if (current === 0) setStreak(1);
      else setStreak(current + 1);

      localStorage.setItem('streakCountedFor', todayY);
    }

    // -------------------- TASK COMPLETION --------------------
    function isTaskCompleted(freq, category, taskIndex) {
      var data = loadData();
      var key = getPeriodKey(freq);
      return !!(data[key] && data[key][category] && data[key][category][taskIndex]);
    }

    function setTaskCompleted(freq, category, taskIndex, value) {
      var data = loadData();
      var key = getPeriodKey(freq);
      if (!data[key]) data[key] = {};
      if (!data[key][category]) data[key][category] = {};
      data[key][category][taskIndex] = !!value;
      saveData(data);
    }

    function getRoomProgress(freq, category, tasks) {
      var completed = 0;
      for (var i = 0; i < tasks.length; i++) {
        if (isTaskCompleted(freq, category, i)) completed++;
      }
      var total = tasks.length;
      var percent = total ? Math.round((completed / total) * 100) : 0;
      return { completed: completed, total: total, percent: percent };
    }

    function maybeDropRoomLoot(freq, category) {
      var taskSet = TASKS[currentMode] && TASKS[currentMode][freq] ? TASKS[currentMode][freq] : {};
      if (!taskSet[category]) return;

      var tasks = taskSet[category].tasks;
      var prog = getRoomProgress(freq, category, tasks);
      if (prog.percent < 100) return;

      var cycleKey = getPeriodKey(freq);
      var lootKey = cycleKey + '::' + currentMode + '::' + category;

      var lootedMap = getRoomLootedMap();
      if (lootedMap[lootKey]) return;

      lootedMap[lootKey] = true;
      setRoomLootedMap(lootedMap);

      var drop = LOOT_TABLE[Math.floor(Math.random() * LOOT_TABLE.length)];
      setCoins(getCoins() + drop.coins);

      addLootLog({
        title: "ğŸ Loot drop: " + drop.text + " (+" + drop.coins + " coins) â€” " + taskSet[category].name + " completed!",
        when: new Date().toLocaleString()
      });

      dopamine("ğŸ LOOT DROP! " + drop.text + " (+" + drop.coins + " coins)");
      playDing('loot');
    }

    // -------------------- RENDER --------------------
    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    function createTaskCard(freq, category, data) {
      var card = document.createElement('div');
      card.className = 'task-card ' + data.color;

      var tasksHtml = '';
      for (var i = 0; i < data.tasks.length; i++) {
        var completedClass = isTaskCompleted(freq, category, i) ? 'completed' : '';
        tasksHtml +=
          '<div class="task-item ' + completedClass + '" data-action="toggleTask" data-freq="' + freq + '" data-category="' + category + '" data-index="' + i + '">' +
            '<div class="checkbox"></div>' +
            '<span class="task-text">' + escapeHtml(data.tasks[i]) + '</span>' +
          '</div>';
      }

      var prog = getRoomProgress(freq, category, data.tasks);

      card.innerHTML =
        '<div class="task-header">' +
          '<div class="task-title">' +
            '<span class="task-icon">' + data.icon + '</span>' +
            '<h3>' + escapeHtml(data.name) + '</h3>' +
          '</div>' +
          '<span class="task-badge">' + freq.toUpperCase() + '</span>' +
        '</div>' +
        '<div class="task-list">' + tasksHtml + '</div>' +
        '<div class="progress-section">' +
          '<div class="progress-label"><span>Progress</span><span>' + prog.percent + '%</span></div>' +
          '<div class="progress-bar"><div class="progress-fill" style="width:' + prog.percent + '%"></div></div>' +
        '</div>';

      return card;
    }

    function renderTasks() {
      var grid = document.getElementById('taskGrid');
      if (!grid) return;
      grid.innerHTML = '';

      var taskSet = (TASKS[currentMode] && TASKS[currentMode][currentFrequency]) ? TASKS[currentMode][currentFrequency] : {};
      var keys = Object.keys(taskSet);

      if (keys.length === 0) {
        grid.innerHTML = '<div class="panel small">No tasks found for this mode/frequency.</div>';
        return;
      }

      keys.forEach(function(category) {
        grid.appendChild(createTaskCard(currentFrequency, category, taskSet[category]));
      });
    }

    // -------------------- TOGGLE TASK --------------------
    function toggleTask(freq, category, taskIndex) {
      var was = isTaskCompleted(freq, category, taskIndex);
      var nowVal = !was;
      setTaskCompleted(freq, category, taskIndex, nowVal);

      if (nowVal) {
        setCoins(getCoins() + 1);
        playDing('task');
        dopamine();

        // streak only cares about daily tasks
        if (freq === 'daily') {
          reconcileStreak();
          bumpStreakIfNeededToday();
        }
      }

      renderTasks();
      maybeDropRoomLoot(freq, category);
      updateHUD();
    }

    // -------------------- MODE / FREQUENCY --------------------
    function setMode(mode) {
      currentMode = mode;
      var btns = document.querySelectorAll('#modeToggle .mode-btn');
      btns.forEach(function(b){ b.classList.remove('active'); });
      document.querySelector('#modeToggle .mode-btn[data-mode="' + mode + '"]').classList.add('active');
      dopamine(mode === 'regular' ? "âœ¨ Full spellbook unlocked. Pick ONE tiny win." : "ğŸ’™ Bare minimum mode. Tiny is mighty.");
      renderTasks();
    }

    function setFrequency(freq) {
      currentFrequency = freq;
      var btns = document.querySelectorAll('#freqToggle .mode-btn');
      btns.forEach(function(b){ b.classList.remove('active'); });
      document.querySelector('#freqToggle .mode-btn[data-freq="' + freq + '"]').classList.add('active');
      dopamine("ğŸ§­ " + freq.toUpperCase() + " quests loaded. Choose ONE.");
      renderTasks();
    }

    // -------------------- MODALS / SHOP --------------------
    function openShop() { document.getElementById('shopModal').style.display = 'block'; }
    function closeShop() { document.getElementById('shopModal').style.display = 'none'; }

    function openLootLog() {
      renderLootLog();
      document.getElementById('lootModal').style.display = 'block';
    }
    function closeLootLog() { document.getElementById('lootModal').style.display = 'none'; }

    function renderLootLog() {
      var list = document.getElementById('lootList');
      list.innerHTML = '';
      var log = getLootLog();
      if (log.length === 0) {
        list.innerHTML = '<div class="small">No loot yet. Complete a room to trigger a loot drop âœ¨</div>';
        return;
      }
      log.forEach(function(item) {
        var div = document.createElement('div');
        div.style.background = 'rgba(255,255,255,0.06)';
        div.style.border = '1px solid rgba(255,255,255,0.10)';
        div.style.borderRadius = '12px';
        div.style.padding = '10px';
        div.innerHTML = '<div style="font-weight:900;">' + escapeHtml(item.title) + '</div>' +
                        '<div class="small">' + escapeHtml(item.when) + '</div>';
        list.appendChild(div);
      });
    }

    function buyShield() {
      var coins = getCoins();
      if (coins < 25) { dopamine("ğŸš« Not enough coins. Tiny quest first."); playDing('nope'); return; }
      setCoins(coins - 25);
      setShields(getShields() + 1);
      addLootLog({ title: "ğŸ›¡ï¸ Bought a shield (-25 coins)", when: new Date().toLocaleString() });
      dopamine("ğŸ›¡ï¸ Shield acquired. Future you is protected.");
      playDing('shield');
      updateHUD();
    }

    function buyReward(label, cost) {
      var coins = getCoins();
      if (coins < cost) { dopamine("ğŸš« Not enough coins. Tiny quest first."); playDing('nope'); return; }
      setCoins(coins - cost);
      addLootLog({ title: "âœ… Redeemed: " + label + " (-" + cost + " coins)", when: new Date().toLocaleString() });
      dopamine("âœ… Redeemed: " + label + " â€” this is allowed.");
      playDing('buy');
      updateHUD();
    }

    // -------------------- TIMER --------------------
    function startTimer(minutes) {
      var endTime = new Date();
      endTime.setMinutes(endTime.getMinutes() + minutes);
      timerEndTime = endTime;

      if (timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(updateTimerDisplay, 1000);
      updateTimerDisplay();
      dopamine("ğŸ§º Timer started. Future you says thank you.");
      playDing('task');
    }

    function stopTimer() {
      if (timerInterval) clearInterval(timerInterval);
      timerInterval = null;
      timerEndTime = null;
      document.getElementById('timerDisplay').textContent = '--:--';
      dopamine("â¹ï¸ Timer stopped. No shame. We pivot.");
      playDing('buy');
    }

    function updateTimerDisplay() {
      if (!timerEndTime) return;

      var now = new Date();
      var diff = timerEndTime - now;

      if (diff <= 0) {
        stopTimer();
        document.getElementById('timerDisplay').textContent = '00:00';
        alert('Timer finished!');
        dopamine("ğŸ‰ Laundry level-up unlocked.");
        playDing('loot');
        return;
      }

      var minutes = Math.floor(diff / 60000);
      var seconds = Math.floor((diff % 60000) / 1000);

      document.getElementById('timerDisplay').textContent =
        (minutes < 10 ? '0' : '') + minutes + ':' + (seconds < 10 ? '0' : '') + seconds;
    }

    // -------------------- RESET --------------------
    function hardReset() {
      if (!confirm("Hard reset EVERYTHING? This clears tasks, coins, shields, streak, loot log.")) return;
      localStorage.removeItem('cleaningTasksV4');
      localStorage.removeItem('coins');
      localStorage.removeItem('shields');
      localStorage.removeItem('cleaningStreak');
      localStorage.removeItem('lootLog');
      localStorage.removeItem('roomLootedMap');
      localStorage.removeItem('streakLastChecked');
      localStorage.removeItem('streakCountedFor');
      updateHUD();
      renderTasks();
      dopamine("ğŸ§¼ Hard reset complete. Fresh slate. Tiny quest time.");
    }

    // -------------------- EVENT WIRING --------------------
    function wireEvents() {
      document.getElementById('openShopBtn').addEventListener('click', openShop);
      document.getElementById('openLootBtn').addEventListener('click', openLootLog);
      document.getElementById('closeShopBtn').addEventListener('click', closeShop);
      document.getElementById('closeLootBtn').addEventListener('click', closeLootLog);
      document.getElementById('hardResetBtn').addEventListener('click', hardReset);

      document.getElementById('buyShieldBtn').addEventListener('click', buyShield);
      document.querySelectorAll('.shopItem').forEach(function(btn){
        btn.addEventListener('click', function(){
          var cost = parseInt(btn.getAttribute('data-cost'), 10);
          var label = btn.getAttribute('data-label');
          buyReward(label, cost);
        });
      });

      document.getElementById('washerBtn').addEventListener('click', function(){ startTimer(45); });
      document.getElementById('dryerBtn').addEventListener('click', function(){ startTimer(60); });
      document.getElementById('stopTimerBtn').addEventListener('click', stopTimer);

      // Mode toggle
      document.querySelectorAll('#modeToggle .mode-btn').forEach(function(btn){
        btn.addEventListener('click', function(){ setMode(btn.getAttribute('data-mode')); });
      });

      // Frequency toggle
      document.querySelectorAll('#freqToggle .mode-btn').forEach(function(btn){
        btn.addEventListener('click', function(){ setFrequency(btn.getAttribute('data-freq')); });
      });

      // Delegated clicks for tasks
      document.body.addEventListener('click', function(e){
        var el = e.target;
        while (el && el !== document.body) {
          if (el.getAttribute && el.getAttribute('data-action') === 'toggleTask') {
            var freq = el.getAttribute('data-freq');
            var cat = el.getAttribute('data-category');
            var idx = parseInt(el.getAttribute('data-index'), 10);
            toggleTask(freq, cat, idx);
            return;
          }
          el = el.parentNode;
        }
      });
    }

    // -------------------- INIT --------------------
    document.addEventListener('DOMContentLoaded', function() {
      updateHUD();
      wireEvents();
      reconcileStreak();
      renderTasks();
      dopamine("âœ¨ Loaded. Pick ONE tiny quest. Coins appear. Magic happens.");
    });
  </script>
</body>
</html>
